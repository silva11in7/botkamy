<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Usuário | Kamy Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #ff2d55;
            --bg: #050505;
            --card-bg: #0f0f0f;
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-dim: #888888;
            --success: #00ff88;
            --warning: #ffcc00;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); display: flex; }
        .main { margin-left: 260px; flex: 1; padding: 2rem 3rem; min-height: 100vh; }

        .back-link { display: flex; align-items: center; gap: 8px; color: var(--text-dim); text-decoration: none; margin-bottom: 2rem; font-size: 0.9rem; transition: 0.2s; }
        .back-link:hover { color: var(--primary); }

        .profile-header { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; }
        .large-avatar { width: 80px; height: 80px; background: #1a1a1a; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--primary); font-weight: 800; border: 2px solid var(--border); }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .detail-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 1.5rem; }
        
        h3 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 1.5rem; }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.9rem; }
        .info-label { color: var(--text-dim); }
        .info-value { font-weight: 600; font-family: 'JetBrains Mono', monospace; }

        .timeline { position: relative; padding-left: 2rem; }
        .timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--border); }
        .timeline-item { position: relative; margin-bottom: 1.5rem; }
        .timeline-item::before { content: ''; position: absolute; left: -2.35rem; top: 5px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .timeline-date { font-size: 0.75rem; color: var(--text-dim); }
        .timeline-content { font-size: 0.9rem; margin-top: 4px; }

        .badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; font-weight: 800; }
        .badge-success { background: rgba(0, 255, 136, 0.1); color: var(--success); }
        .badge-pending { background: rgba(255, 204, 0, 0.1); color: var(--warning); }
    </style>
</head>
<body>
    {% include 'base_sidebar.html' %}

    <main class="main">
        <a href="/usuarios" class="back-link"><i data-lucide="arrow-left"></i> Voltar para Lista</a>

        <div class="profile-header">
            <div class="large-avatar">{{ user.full_name[:1]|upper if user.full_name else '?' }}</div>
            <div>
                <h1 style="margin:0">{{ user.full_name or "Cliente Anônimo" }}</h1>
                <p style="color:var(--primary); font-weight: 600; margin: 5px 0 0 0;">@{{ user.username or "Sem Username" }}</p>
                <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 8px;">Membro desde: {{ user.created_at[:16] }}</div>
            </div>
        </div>

        <div class="detail-grid">
            <!-- Tracking Info -->
            <div class="detail-card">
                <h3><i data-lucide="map"></i> Origem e Rastreio</h3>
                <div class="info-row">
                    <span class="info-label">UTM Source</span>
                    <span class="info-value" style="color:var(--primary)">{{ user.utm_source or 'Direto' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">UTM Campaign</span>
                    <span class="info-value">{{ user.utm_campaign or '--' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">UTM Medium</span>
                    <span class="info-value">{{ user.utm_medium or '--' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">TikTok Click ID</span>
                    <span class="info-value" style="font-size: 0.7rem">{{ user.ttclid or 'Não disponível' }}</span>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="detail-card">
                <h3><i data-lucide="credit-card"></i> Histórico de Compras</h3>
                {% if transactions %}
                    {% for tx in transactions %}
                    <div style="padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--border)">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <span style="font-weight:700">R$ {{ "%.2f"|format(tx.amount) }}</span>
                            <span class="badge {{ 'badge-success' if tx.status == 'confirmed' else 'badge-pending' }}">{{ tx.status }}</span>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 5px;">{{ tx.created_at[:16] }} | Pix</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align:center; color:var(--text-dim); padding: 2rem;">Nenhuma transação encontrada.</div>
                {% endif %}
            </div>

            <!-- Event Timeline -->
            <div class="detail-card" style="grid-column: span 2">
                <h3><i data-lucide="activity"></i> Linha do Tempo de Interação</h3>
                <div class="timeline">
                    {% for event in events %}
                    <div class="timeline-item">
                        <div class="timeline-date">{{ event.created_at[:16] }}</div>
                        <div class="timeline-content">
                            Event: <strong style="color:var(--primary)">{{ event.event_type|upper }}</strong> 
                            {% if event.event_type == 'start' %} (Iniciou o Bot)
                            {% elif event.event_type == 'view_plans' %} (Viu os Planos)
                            {% elif event.event_type == 'checkout' %} (Gerou Pix/Checkout)
                            {% elif event.event_type == 'payment_success' %} (Pagamento Confirmado ✅)
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div style="text-align:center; color:var(--text-dim); padding: 2rem;">Nenhum evento registrado.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>

    <script>lucide.createIcons();</script>
</body>
</html>
